# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами


## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```

## Сборка

```
npm run build
```

или

```
yarn build
```


## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP. Имеет некоторый базовый код.
Также есть дополнительный слой коммуникации для связи с сервером.
Принцип MVP подразумевает что проект будет разделен на 3 основных слоя: слой данных - то, где хранятся данные,
слой отображения - инструменты для визуальной работы с данными, и слой презентер -
обеспечит взаимодествие двух предыдущих слоя.


## Данные и типы данных, используемые в приложении

Карточка продукта

```
interface IProduct {
    id: string;
    description: string;
    image: string;
    title: string;
    category: string;
    price: number;
};
```

Заказ

```
interface IOrder {
    payment: string;
    email: string;
    phone: string;
    address: string;
    total: number;
    items: string[];
};
```

Интерфейс для хранения актуальных карточек товаров

```
interface ICatalogModel {
    items: IProduct[];
    setItems(items: IProduct[]): void;
    getProduct(id: string): IProduct;
};
```

Интерфейс для хранения корзины

```
interface IBasketModel {
    items: TProductInfo[];
    events: IEvents;
    add(item: TProductInfo): void;
    remove(id: string): void;
    hasItem(id: string): boolean;
    getTotal(): number;
    getIdList(): string[]
    reset(): void; 
};
```

Данные карточки, используемые в корзине

```
export type TProductInfo = Pick<IProduct, 'id' | 'title' | 'price'> & {
    index?: number;
};
```

Интерфейс для хранения информации о заказе

```
export interface IOrderModel {
    orderInfo: Partial<TFullOrder>;
    formErrors: FormErrors;
    events: IEvents;
    getOrderInfo(): TFullOrder
    setOrderField(field: keyof TFullOrder, value: string): void;
    formErrorsChange(errors: FormErrors): boolean;
    reset(): void;
};
```

Тип первичных данных объекта ифнормации заказа

```
export type TOrderInfo = Pick<IOrder, 'payment' | 'address'>;
```

Тип данных объекта ифнормации заказа с контактами

```
export type TOrderContacts = Pick<IOrder, 'email' | 'phone'>;
```

Тип полного объекта информации заказа
```
export type TFullOrder = TOrderInfo & TOrderContacts;
```

Тип данных содержащий ошибку и указатель на поле формы
```
export type FormErrors = Partial<Record<keyof IOrder, string>>;
```


### Базовый код

#### Класс Api
Содержит в себе базовую логику отправки запросов.
В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы:
- `get(uri: string): Promise` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post(uri: string, data: object, method: ApiPostMethods = 'POST'): Promise` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет
эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра\
при вызове.

#### Класс EventEmitter
Брокер событий позволяет создавать собственные события а также подписываться на них. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.
Реализует интерфейс `IEvents`.
В конструктор передается массив из событий и подписчиков.
Основные методы:
- `on<T extends object>(eventName: EventName, callback: (event: T) => void): void` - подписка на событие.
- `emit<T extends object>(eventName: string, data?: T): void` - инициализация события.
- `trigger<T extends object>(eventName: string, context?: Partial<T>): void` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие.

#### Класс Component
Класс компонент является родителем для всех остальных классов отображения в проекте. Предоставляет базовые методы для работы с отображением.
В конструктор мы передаеnся элемент разметки.
Методы:
- `render(data?: Partial<T>): HTMLElement` - основной метод класса, который позволяет отрисовать нужные элементы разметки.
- `toggleClass(element: HTMLElement, className: string, force?: boolean): void` - добавить/убрать класс жлементу разметки.
- `protected setText(element: HTMLElement, value: unknown): void` - добавить текстовое содержание в свойство `textContent` элемента разметки.


### Классы коммуникации

#### Класс LarekApi
Класс наследник Api. В конструктор получает адрес сервера и CDN.
Методы:
-`getProducts(): Promise<IProduct[]>` - возвращает фетч родительского метода get() с указанием на эндпоинт '/product/' а также на основании массива полученного от сервера формирует\ новый массив, где конкретно под картинку формируется специальное значение (CDN + эндпоинт записаный на сервере). Таким образом формируется список продуктов для CatalogModel.
-`postOrder(data: IOrder): Promise<ApiOrderResponse>` - возвращает фетч родительского метода post(), во время которого делает на сервер запрос методом POST, с эндпоинтом '/order/'.
Таким образом на сервер отправляется объект из корзины, а в приложение приходит ответ от сервера в виде объекта с id и total.


### Слой модели данных

#### Класс CatalogModel
Класс отвечает за хранение данных карточек.
Конструктор класса принимает инстант брокера событий.
В полях класса хранятся следующие данные:
- `items: IProduct[]` - массив объектов карточек
Так же класс предоставляет набор методов для взаимодействия с этими данными.
- `setItems(items: IProduct[]): void` - записывает в items массив переданных ему объектов карточек.
- `getProduct(id: string): IProduct` - возвращает карточку продукта из записанного ранее массива по ее id.

#### Класс BasketModel
Класс отвечает за хранение продуктов в корзине.
Конструктор класса принимает инстант брокера событий
В полях класса хранятся следующие данные:
- `items: TProductInfo[]` - массив выбранных для покупки продуктов
- `events: IEvents` - инстант класса `EventEmitter` для инициации события при изменении корзины.
Так же класс предоставляет набор методов для взаимодействия с этими данными
- `add(item: TProductInfo): void` - добавляет продукт в корзину, формирует событие для презенетера об изменении корзины
- `remove(id: string): void` - удаляет продукт из корзины, формирует событие для презенетера об изменении корзины
- `hasItem(id: string): boolean` - проверяет наличие продукта в корзине
- `getIdList(): string[]` - формирует массив из Id карточек содержащихся в items
- `getTotal(): number` - считает сумму стоимости продуктов в корзине
- `reset(): void` - обнуляет данные корзины, формирует событие для презенетера об изменении корзины

#### Класс OrderModel
Класс отвечает за хранение и работу с данными заказа. В конструтор принимает инстант брокера событий, там же резетит свое содержимое.
Поля класса:
- `orderInfo: Partial<TFullOrder>` - объект с данными заказа.
- `formErrors: FormErrors` - объект с полем и текстом ошибки.
- `events: IEvents` - инстант класса `EventEmitter` для инициации событий заполнения данных заказа.
Методы:
- `getOrderInfo(): TFullOrder` - предоставляет данные из объекта orderInfo в форме TFullOrder, это нужно чтобы сформировать объект на отправку на сервер, т.к. данные\
с нескольких форм заполняются постепенно, изпользуя механику Partial.
- `setOrderField(field: keyof TFullOrder, value: string): void` - заполняет поля класса, также проверяет валидацию и вписывает в formErrors нужный текст ошибки формы.
- `formErrorsChange(errors: FormErrors): boolean` - получает объект с возможными ошибками и возвращает положительный ответ в случае наличия ошибок на форме, генерирует\
соответствующее событие для презентера
- `reset(): void` - резетит содержимое класса (orderInfo и formErrors).


### Слой представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Класс Page
Класс харнит в себе основные элементы с главной страницы. Такие как галерея с карточками, корзина и ее счетчик.
Конструктор, кроме главного элемента страницы принимает экземпляр `EventEmitter` для инициации событий.
Размещает в себе карточки из CatalogModel. Cлушает нажатие на корзинку и формирует нужное событие для презентера.

#### Класс Card
Отвечает за отображение карточки, задавая в карточке данные названия, описания и цены. Класс используется как рордитель для всех его потомков, которые отвечают за отображение\
карточки в различных контекстах (на главной странице, в превью или в корзине). В классе устанавливаются слушатель нажатия на карточку для открытия ее в модальном окне.
Поля класса содержат элементы разметки элементов карточки. Конструктор, кроме темплейта принимает экземпляр `EventEmitter` для инициации событий.
Наследники класса:
    - Класс `GalleryCard` - расширяет возможнсти родителя записью новых свойств категории и картинки, вешает на весь контейнер слушатель клика для отправки в перезентер события\
    на открытие мального окна с превью карточки.
       - Имеет наследника класс `FullCard` - расширяет возможности родителя добавлением описания и кнопки добавления/удаления из корзины карточки(вешает на нее слушаетль клика с\ генерацией нужного события для презентиера)
    - Класс `CompactCard` - расширяет возможности родителя добавлением индекса(поля, которое мы создаем чтобы отображать нумерацию позиций продуктов в корзине), а также кнопки\ удаления из корзины(вешает на нее слушаетль клика с генерацией события для презентиера).

#### Класс Modal
Реализует модальное окно. Устанавливает слушатели для закрытия модального окна на клик в оверлей и кнопку-крестик для закрытия попапа. А также отрисовывает содержимое, которое\ 
ему передается в презентере (карточка, корзина и модальные окна). Конструктор принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно и\
экземпляр класса `EventEmitter` для возможности инициации событий.
Методы:
- `open(): void` - добавляет класс видимости модального окна и формирует соответствующее событие для презентера.
- `close(): void` - удаляет класс видимости модального окна и формирует соответствующее событие для презентера.
- `render(data: IModalData): HTMLElement` - переопределяет метод родителя Component позволяя модальному окну отобразиться при рендере.

#### Класс Basket
Класс наследник Component, для отображения корзины. Прнимает экземпляр `EventEmitter` для инициации событий, а также записывает перечень карточек, общую стоимость и кнопку для\ 
начала оформления покупки. Оповещает текстом, если корзина пуста. Дизейблит кнопку, если товары отсутствуют, при этом прверяет корзину на ненулевую стоимость, хоть бесценный\
товар и невозможно добавить.

#### Класс Form
Класс наследник Component. Необходим для работы форм, отрисовывает ошибки и через валидацию делает сабмит возможным, отправляя в презентер события связанные с изменениями\ 
в инпутах. В конструктор получает объект кнопки сабмита а также поле для вывода ошибки текущей формы, там же вешает слушаетели 'input' и 'submit'.
Методы:
- `protected onInputChange(field: keyof T, value: string): void` - получается название и значение изменяемого инпута, генерирует событие о том что заказ изменен и передает
эти значения в эмите
- `reset()` - резетит текущую форму
- `render(state: Partial<T> & IFormState): HTMLFormElement` - отрисовывает текущую форму

#### Класс OrderInfo
Отвечает за отрисовку первой формы, а также за логику работы кнопки типа оплаты. Наследуются от Form, в презентер получает клон темплейта а также экземпляр `EventEmitter`.
Методы:
- `setButtonCheck(value: string): void` - Подсвечвает нажатую кнопку, остальные приводит в ненажатое состояние.

#### Класс OrderContacts
Отвечает за отрисовку второй формы. Наследуются от Form, в презентер получает клон темплейта а также экземпляр `EventEmitter`.

#### Класс Success
Отвечает за отрисовку формы успешного заказа. Получает темплейт и функцию действия. Имеет формальную кнопку завершения. А также вписывает при рендере сумму заказа полученную 
из перезентера (туда она попадает из апи).


### Слой презентера
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

Пример взаимодействия:
1. Пользователь нажимает кнопку "В Корзину" в превью карточки продукта и класс `FullCard` генерирует событие `card_full:select`
2. Презентер отслеживает событие и вызывает метод `add` класса `BasketModel`, попутно закрывая модальное окно - `modal.close()`
3. `BasketModel` записывает переданный объект и генерирует событие `basket:change`
4. Презентер обрабатывает событие `basket:change` и обращается к `counter` класса `Page` и записывает туда длину списка `BasketModel`
5. Происходит рендер корзины с новым числом товаров. В тоже время внутри корзины, которую мы не видим, проиходит отрисовка нового элемента и новой суммы заказа.

## Список уникальных событий для работы презентера
*События Api*
- `catalog:update` - происходит, когда приложение получает список продуктов от сервера

*События моделей данных*
- `basket:change` - изменение списка товаров в корзине

*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)*
- `card:modal` - нажатие на карточку в каталоге
- `basket:open` - нажали на иконку корзины в шапке сайта
- `modal:open` - открыли модальное окно
- `modal:close` - закрыли модальное окно
- `card_full:select` - выбор продукта для добавления в корзину
- `basket__item:remove` - выбор продукта для удаления из корзины
- `basket:confirm` - нажатие кнопки оформить в корзине
- `order:change` - изменилась инорфмация по заказу на формах
- `order:submit` - подтверждение заполнения информации о покупки
- `contacts:submit` - подтверждение заполнения контактов и отправка покупки на сервер